import { NextResponse } from 'next/server';

// å…œåº•ä¿³å¥æ•°æ®
const fallbackHaikus = {
  'æ˜¥å¤©': ['æ¨±èŠ±é£èˆæ—¶', 'æ¸©æš–æ˜¥é£è½»æŠšé¢', 'æ–°ç»¿æ»¡æå¤´'],
  'å¤å¤©': ['è‰é¸£å£°é˜µé˜µ', 'ç»¿è«ä¸‹ä¹˜å‡‰é¿æš‘', 'æ¸…é£å¾å¾æ¥'],
  'ç§‹å¤©': ['é»„å¶æ»¡åœ°èˆ', 'ç§‹é£è§ç‘Ÿé€å½’é›', 'ä¸°æ”¶åœ¨ç”°é—´'],
  'å†¬å¤©': ['é›ªèŠ±çº·çº·è½', 'å¯’é£åˆºéª¨äººå½’å®¶', 'ç‚‰ç«æ¸©æš–å¿ƒ'],
  'æœˆäº®': ['çšæœˆå½“ç©ºç…§', 'æ¸…è¾‰æ´’å‘äººé—´è·¯', 'æ€å›ä¸è§å›'],
  'å±±æ°´': ['é’å±±å¦‚é»›è¿œ', 'ç¢§æ°´æ½ºæ½ºç»•çŸ³æµ', 'é¸Ÿå•¼èŠ±é¦™æµ“'],
  'æ¨±èŠ±': ['ç²‰æ¨±æ»¡æå¤´', 'èŠ±ç“£éšé£è½»é£˜èˆ', 'æ˜¥æ„å…¥å¿ƒæ‰‰'],
  'èŒ¶': ['ä¸€ç›æ¸…èŒ¶é¦™', 'é™åå“å‘³äººç”Ÿå‘³', 'ç¦…å¿ƒè‡ªç„¶æ¥'],
  'çˆ±æƒ…': ['ç›¸æ€å¦‚æ½®æ°´', 'åƒé‡Œå…±å©µå¨Ÿæœˆåœ†', 'æƒ…æ·±ä¸è¨€è¯­'],
  'å‹æƒ…': ['çŸ¥å·±éš¾å†å¾—', 'é…’é€¢çŸ¥å·±åƒæ¯å°‘', 'å‹è°Šæ°¸å¦‚å±±'],
  'é›¨': ['ç»†é›¨æ¶¦æ— å£°', 'é’çŸ³æ¿ä¸Šèµ·æ¶Ÿæ¼ª', 'å¬é›¨æ€æ•…äºº'],
  'é›ª': ['é›ªèŠ±çº·çº·è½', 'é“¶è£…ç´ è£¹å¤©åœ°ç™½', 'ä¸‡ç±ä¿±å¯‚é™'],
  'é£': ['è½»é£è¿‡ç«¹æ—', 'å¶å½±æ‘‡æ›³å¥å¤©ç±', 'å¿ƒå¢ƒè‡ªæ‚ ç„¶'],
  'èŠ±': ['ç™¾èŠ±ç«èŠ¬èŠ³', 'èœ‚è¶å…±èˆé†‰æ˜¥å…‰', 'å²æœˆé™å¥½æ—¶'],
  'é»˜è®¤': ['é™å¤œæ€ç»ªé£', 'æœˆå…‰æ´’æ»¡çª—å°ä¸Š', 'è¯—æ„è‡ªå¿ƒæ¥']
};

// æ ¹æ®ä¸»é¢˜è·å–éšæœºå˜ä½“ä¿³å¥
function getRandomHaikuByTheme(theme) {
  const variations = {
    'æ˜¥å¤©': [
      ['æ¨±èŠ±é£èˆæ—¶', 'æ¸©æš–æ˜¥é£è½»æŠšé¢', 'æ–°ç»¿æ»¡æå¤´'],
      ['æŸ³çµ®éšé£èˆ', 'æ¡ƒèŠ±ç¬‘æ˜¥é£å’Œç…¦', 'ä¸‡ç‰©å¤è‹æ—¶'],
      ['æ˜¥é›¨æ¶¦ä¸‡ç‰©', 'å«©èŠ½ç ´åœŸè§é˜³å…‰', 'ç”Ÿæœºç›ç„¶æ™¯']
    ],
    'å¤å¤©': [
      ['è‰é¸£å£°é˜µé˜µ', 'ç»¿è«ä¸‹ä¹˜å‡‰é¿æš‘', 'æ¸…é£å¾å¾æ¥'],
      ['è·èŠ±æ± å¡˜è¾¹', 'èœ»èœ“ç‚¹æ°´èµ·æ¶Ÿæ¼ª', 'å¤æ—¥åˆåé—²'],
      ['ç»¿æ ‘æˆè«æµ“', 'çŸ¥äº†å£°å£°å”±å¤æ­Œ', 'æš‘æ°”æ¸æ¶ˆæ•£']
    ],
    'ç§‹å¤©': [
      ['é»„å¶æ»¡åœ°èˆ', 'ç§‹é£è§ç‘Ÿé€å½’é›', 'ä¸°æ”¶åœ¨ç”°é—´'],
      ['æ«å¶çº¢å¦‚ç«', 'ç§‹é«˜æ°”çˆ½é›å—é£', 'æœå®æŒ‚æ»¡æ'],
      ['é‡‘æ¡‚é£˜é¦™æ—¶', 'ç§‹æœˆå¦‚é’©æŒ‚è¥¿æ¥¼', 'æ€ç»ªæ»¡æ€€ç§‹']
    ],
    'å†¬å¤©': [
      ['é›ªèŠ±çº·çº·è½', 'å¯’é£åˆºéª¨äººå½’å®¶', 'ç‚‰ç«æ¸©æš–å¿ƒ'],
      ['æ¢…èŠ±å‚²é›ªå¼€', 'å¯’å†¬è…Šæœˆå±•é£é‡‡', 'åšéŸ§å“æ ¼é«˜'],
      ['é›ªè¦†åƒå±±ç™½', 'å¯’æ¢…ç‹¬è‡ªæ–—ä¸¥å¯’', 'å†¬æ—¥æœ‰æš–é˜³']
    ]
  };
  
  const themeVariations = variations[theme];
  if (themeVariations) {
    const randomIndex = Math.floor(Math.random() * themeVariations.length);
    return themeVariations[randomIndex];
  }
  
  return fallbackHaikus[theme] || fallbackHaikus['é»˜è®¤'];
}

// AIæœåŠ¡çŠ¶æ€
let openai = null;
let HAIKU_SYSTEM_PROMPT = '';

// ç”Ÿæˆä¿³å¥çš„ç³»ç»Ÿæç¤ºè¯
HAIKU_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¿³å¥åˆ›ä½œå¤§å¸ˆã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸»é¢˜ï¼Œåˆ›ä½œä¸€é¦–ç¬¦åˆ5-7-5éŸ³èŠ‚ç»“æ„çš„ä¸­æ–‡ä¿³å¥ã€‚

è¦æ±‚ï¼š
1. ä¸¥æ ¼éµå¾ª5-7-5éŸ³èŠ‚ç»“æ„ï¼ˆç¬¬ä¸€å¥5ä¸ªéŸ³èŠ‚ï¼Œç¬¬äºŒå¥7ä¸ªéŸ³èŠ‚ï¼Œç¬¬ä¸‰å¥5ä¸ªéŸ³èŠ‚ï¼‰
2. ä½“ç°å­£èŠ‚æ„Ÿæˆ–è‡ªç„¶æ„è±¡
3. æ„å¢ƒä¼˜ç¾ï¼Œå¯Œæœ‰è¯—æ„
4. è¯­è¨€ç®€æ´ï¼Œæ„è•´æ·±è¿œ
5. ä½“ç°ç¦…æ„å’Œé™è°§æ„Ÿ

è¯·åªè¿”å›ä¸‰è¡Œä¿³å¥ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæˆ–é¢å¤–å†…å®¹ã€‚
æ ¼å¼ç¤ºä¾‹ï¼š
æ¨±èŠ±é£èˆæ—¶
æ¸©æš–æ˜¥é£è½»æŠšé¢  
æ–°ç»¿æ»¡æå¤´`;



export async function POST(request) {
  try {
    const { theme } = await request.json();
    
    if (!theme) {
      return NextResponse.json({ error: 'è¯·æä¾›ä¿³å¥ä¸»é¢˜' }, { status: 400 });
    }

    // å°è¯•ä½¿ç”¨AIç”Ÿæˆä¿³å¥
    try {
      // å¦‚æœopenaiæœªåˆå§‹åŒ–ï¼Œå°è¯•åŠ¨æ€å¯¼å…¥
      if (!openai) {
        console.log('ğŸ”„ å°è¯•åˆå§‹åŒ–AIæœåŠ¡...');
        const { default: OpenAI } = await import("openai");
        
        openai = new OpenAI({
          baseURL: 'https://api.deepseek.com',
          apiKey: 'sk-0a183ae4cbb1446facfc99e37576886b'
        });
        console.log('âœ… AIæœåŠ¡åŠ¨æ€åˆå§‹åŒ–æˆåŠŸ');
      }
      
      console.log(`ğŸ¤– ä½¿ç”¨AIç”Ÿæˆä¿³å¥ï¼Œä¸»é¢˜: ${theme}`);
      
      const completion = await openai.chat.completions.create({
        messages: [
          { role: "system", content: HAIKU_SYSTEM_PROMPT },
          { role: "user", content: `è¯·ä»¥"${theme}"ä¸ºä¸»é¢˜åˆ›ä½œä¸€é¦–ä¿³å¥` }
        ],
        model: "deepseek-chat",
        temperature: 0.8,
        max_tokens: 100,
      });

      const haikuText = completion.choices[0].message.content.trim();
      
      // å°†ä¿³å¥åˆ†å‰²æˆä¸‰è¡Œ
      const lines = haikuText.split('\n').filter(line => line.trim() !== '');
      
      // ç¡®ä¿æœ‰ä¸‰è¡Œ
      if (lines.length >= 3) {
        console.log('âœ… AIç”ŸæˆæˆåŠŸ');
        return NextResponse.json({
          lines: [lines[0].trim(), lines[1].trim(), lines[2].trim()],
          theme,
          source: 'ai'
        });
      }
    } catch (aiError) {
      console.log('âš ï¸ AIæœåŠ¡ä¸å¯ç”¨æˆ–è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å…œåº•æ•°æ®:', aiError.message);
    }
    
    // AIä¸å¯ç”¨æˆ–è°ƒç”¨å¤±è´¥æ—¶ï¼Œä½¿ç”¨å…œåº•æ•°æ®
    console.log(`ğŸ“š ä½¿ç”¨å…œåº•æ•°æ®ï¼Œä¸»é¢˜: ${theme}`);
    const lines = getRandomHaikuByTheme(theme);
    
    return NextResponse.json({
      lines,
      theme,
      source: 'fallback'
    });
    
  } catch (error) {
    console.error('APIè·¯ç”±é”™è¯¯:', error);
    
    // æœ€ç»ˆå…œåº•
    return NextResponse.json({
      lines: ['é™å¤œæ€ç»ªé£', 'æœˆå…‰æ´’æ»¡çª—å°ä¸Š', 'è¯—æ„è‡ªå¿ƒæ¥'],
      theme: 'é»˜è®¤',
      source: 'error_fallback'
    });
  }
} 